/**
 * Hilo 1.0.2 for commonjs
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
var Class=require("..coreClass"),Renderer=require("./Renderer"),Matrix=require("..geomMatrix"),DEG2RAD=Math.PI/180,WebGLRenderer=Class.create({Extends:Renderer,Statics:{MAX_BATCH_NUM:2e3,ATTRIBUTE_NUM:5,isSupport:function(){if(void 0==this._isSupported){var e=document.createElement("canvas");e.getContext&&(e.getContext("webgl")||e.getContext("experimental-webgl"))?this._isSupported=!0:this._isSupported=!1}return this._isSupported}},renderType:"webgl",gl:null,_isContextLost:!1,_cacheTexture:{},constructor:function(e){WebGLRenderer.superclass.constructor.call(this,e);var t=this;this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),this.maxBatchNum=WebGLRenderer.MAX_BATCH_NUM,this.positionStride=4*WebGLRenderer.ATTRIBUTE_NUM;var r=this.maxBatchNum*WebGLRenderer.ATTRIBUTE_NUM*4,i=6*this.maxBatchNum;this.arrayBuffer=new ArrayBuffer(4*r),this.float32Array=new Float32Array(this.arrayBuffer),this.uint32Array=new Uint32Array(this.arrayBuffer),this.indexs=new Uint16Array(i);for(var a=0,n=0;a<i;a+=6,n+=4)this.indexs[a+0]=n+0,this.indexs[a+1]=n+1,this.indexs[a+2]=n+2,this.indexs[a+3]=n+1,this.indexs[a+4]=n+2,this.indexs[a+5]=n+3;this.batchIndex=0,this.sprites=[],this.canvas.addEventListener("webglcontextlost",function(e){t._isContextLost=!0,e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",function(e){t._isContextLost=!1,t.setupWebGLStateAndResource()},!1),this.setupWebGLStateAndResource()},setupWebGLStateAndResource:function(){var e=this.gl;e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,0),e.disable(e.DEPTH_TEST),e.disable(e.CULL_FACE),e.enable(e.BLEND),this._cacheTexture={},this._initShaders(),this.defaultShader.active(),this.positionBuffer=e.createBuffer(),this.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.indexs,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,this.arrayBuffer,e.DYNAMIC_DRAW),e.vertexAttribPointer(this.a_position,2,e.FLOAT,!1,this.positionStride,0),e.vertexAttribPointer(this.a_TexCoord,2,e.FLOAT,!1,this.positionStride,8),e.vertexAttribPointer(this.a_tint,4,e.UNSIGNED_BYTE,!0,this.positionStride,16)},context:null,startDraw:function(e){return!!(e.visible&&e.alpha>0)&&(e===this.stage&&this.clear(),!0)},draw:function(e){var t=e.width,r=e.height,i=(e.background,e.drawable),a=i&&i.image;if(a){var n=i.rect,s=n[2],o=n[3];t||r||(t=e.width=s,r=e.height=o),this.batchIndex>=this.maxBatchNum&&this._renderBatches();var h=this._createVertexs(a,n[0],n[1],s,o,0,0,t,r),d=this.batchIndex*this.positionStride,_=this.float32Array,c=this.uint32Array,l=(e.tint>>16)+(65280&e.tint)+((255&e.tint)<<16)+(255*e.__webglRenderAlpha<<24);_[d+0]=h[0],_[d+1]=h[1],_[d+2]=h[2],_[d+3]=h[3],c[d+4]=l,_[d+5]=h[4],_[d+6]=h[5],_[d+7]=h[6],_[d+8]=h[7],c[d+9]=l,_[d+10]=h[8],_[d+11]=h[9],_[d+12]=h[10],_[d+13]=h[11],c[d+14]=l,_[d+15]=h[12],_[d+16]=h[13],_[d+17]=h[14],_[d+18]=h[15],c[d+19]=l;for(var u=e.__webglWorldMatrix,f=0;f<4;f++){var x=_[d+5*f],g=_[d+5*f+1];_[d+5*f]=u.a*x+u.c*g+u.tx,_[d+5*f+1]=u.b*x+u.d*g+u.ty}e.__textureImage=a,this.sprites[this.batchIndex++]=e}},endDraw:function(e){e===this.stage&&this._renderBatches()},transform:function(e){var t=e.drawable;if(t&&t.domElement)return void Hilo.setElementStyleByView(e);var r=e.scaleX,i=e.scaleY;if(e===this.stage){var a=this.canvas.style,n=e._scaleX,s=e._scaleY,o=!1;(!n&&1!=r||n&&n!=r)&&(e._scaleX=r,a.width=r*e.width+"px",o=!0),(!s&&1!=i||s&&s!=i)&&(e._scaleY=i,a.height=i*e.height+"px",o=!0),o&&e.updateViewport(),e.__webglWorldMatrix=e.__webglWorldMatrix||new Matrix(1,0,0,1,0,0)}else e.parent&&(e.__webglWorldMatrix=e.__webglWorldMatrix||new Matrix(1,0,0,1,0,0),this._setConcatenatedMatrix(e,e.parent));e.alpha>0&&(e.parent&&e.parent.__webglRenderAlpha?e.__webglRenderAlpha=e.alpha*e.parent.__webglRenderAlpha:e.__webglRenderAlpha=e.alpha)},remove:function(e){var t=e.drawable,r=t&&t.domElement;if(r){var i=r.parentNode;i&&i.removeChild(r)}},clear:function(e,t,r,i){this.gl.clear(this.gl.COLOR_BUFFER_BIT)},resize:function(e,t){if(this.width!==e||this.height!==t){var r=this.canvas,i=this.stage,a=r.style;this.width=r.width=e,this.height=r.height=t,a.width=i.width*i.scaleX+"px",a.height=i.height*i.scaleY+"px",this.gl.viewport(0,0,e,t),this.canvasHalfWidth=.5*e,this.canvasHalfHeight=.5*t,this._uploadProjectionTransform(!0)}},_renderBatches:function(){var e=this.gl;e.bufferSubData(e.ARRAY_BUFFER,0,this.uint32Array.subarray(0,this.batchIndex*this.positionStride));for(var t=0,r=0,i=null,a=0;a<this.batchIndex;a++){var n=this.sprites[a];i&&i!==n.__textureImage&&(this._renderBatch(t,a),t=a,r=1),i=n.__textureImage}this._renderBatch(t,this.batchIndex),this.batchIndex=0},_renderBatch:function(e,t){var r=this.gl,i=t-e;i>0&&(r.bindTexture(r.TEXTURE_2D,this._getTexture(this.sprites[e])),r.drawElements(r.TRIANGLES,6*i,r.UNSIGNED_SHORT,6*e*2))},_uploadProjectionTransform:function(e){this._projectionTransformElements&&!e||(this._projectionTransformElements=new Float32Array([1/this.canvasHalfWidth,0,0,0,-1/this.canvasHalfHeight,0,-1,1,1])),this.gl.uniformMatrix3fv(this.u_projectionTransform,!1,this._projectionTransformElements)},_initShaders:function(){var e="            attribute vec2 a_position;\n            attribute vec2 a_TexCoord;\n            attribute vec4 a_tint;\n            uniform mat3 u_projectionTransform;\n            varying vec2 v_TexCoord;\n            varying vec4 v_tint;\n            void main(){\n                gl_Position =  vec4((u_projectionTransform * vec3(a_position, 1.0)).xy, 1.0, 1.0);\n                v_TexCoord = a_TexCoord;\n                v_tint = vec4(a_tint.rgb * a_tint.a, a_tint.a);\n            }\n        ",t="\n            precision mediump float;\n            uniform sampler2D u_Sampler;\n            varying vec2 v_TexCoord;\n            varying vec4 v_tint;\n            void main(){\n                gl_FragColor = texture2D(u_Sampler, v_TexCoord) * v_tint;\n            }\n        ";this.defaultShader=new Shader(this,{v:e,f:t},{attributes:["a_position","a_TexCoord","a_tint"],uniforms:["u_projectionTransform","u_Sampler"]})},_createVertexs:function(e,t,r,i,a,n,s,o,h){var d=this.__tempVertexs||[],_=e.width,c=e.height;i/=_,a/=c,t/=_,r/=c,o=o,h=h,n=n,s=s,i+t>1&&(i=1-t),a+r>1&&(a=1-r);var l=0;return d[l++]=n,d[l++]=s,d[l++]=t,d[l++]=r,d[l++]=n+o,d[l++]=s,d[l++]=t+i,d[l++]=r,d[l++]=n,d[l++]=s+h,d[l++]=t,d[l++]=r+a,d[l++]=n+o,d[l++]=s+h,d[l++]=t+i,d[l++]=r+a,d},_setConcatenatedMatrix:function(e,t){var r=e.__webglWorldMatrix,i=1,a=0,n=e.rotation%360,s=e.pivotX,o=e.pivotY,h=e.scaleX,d=e.scaleY;if(n){var _=n*DEG2RAD;i=Math.cos(_),a=Math.sin(_)}r.a=i*h,r.b=a*h,r.c=-a*d,r.d=i*d,r.tx=e.x-r.a*s-r.c*o,r.ty=e.y-r.b*s-r.d*o,r.concat(t.__webglWorldMatrix)},_getTexture:function(e){var t=e.__textureImage,r=this._cacheTexture[t.src];return r||(r=this.activeShader.uploadTexture(t)),r}}),Shader=function(e,t,r){this.renderer=e,this.gl=e.gl,this.program=this._createProgram(this.gl,t.v,t.f),r=r||{},this.attributes=r.attributes||[],this.uniforms=r.uniforms||[]};Shader.prototype={active:function(){var e=this,t=e.renderer,r=e.gl,i=e.program;i&&r&&(t.activeShader=e,r.useProgram(i),e.attributes.forEach(function(e){t[e]=r.getAttribLocation(i,e),r.enableVertexAttribArray(t[e])}),e.uniforms.forEach(function(e){t[e]=r.getUniformLocation(i,e)}),e.width===t.width&&e.height===t.height||(e.width=t.width,e.height=t.height,t._uploadProjectionTransform()))},uploadTexture:function(e){var t=this.gl,r=this.renderer,i=t.createTexture(),a=r.u_Sampler;return t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.uniform1i(a,0),t.bindTexture(t.TEXTURE_2D,null),this.renderer._cacheTexture[e.src]=i,i},_createProgram:function(e,t,r){var i=this._createShader(e,e.VERTEX_SHADER,t),a=this._createShader(e,e.FRAGMENT_SHADER,r);if(!i||!a)return null;var n=e.createProgram();if(n){e.attachShader(n,i),e.attachShader(n,a),e.linkProgram(n),e.deleteShader(a),e.deleteShader(i);var s=e.getProgramParameter(n,e.LINK_STATUS);if(!s){var o=e.getProgramInfoLog(n);return console.log("Failed to link program: "+o),e.deleteProgram(n),null}}return n},_createShader:function(e,t,r){var i=e.createShader(t);if(i){e.shaderSource(i,r),e.compileShader(i);var a=e.getShaderParameter(i,e.COMPILE_STATUS);if(!a){var n=e.getShaderInfoLog(i);return console.log("Failed to compile shader: "+n),e.deleteShader(i),null}}return i}},module.exports=WebGLRenderer;