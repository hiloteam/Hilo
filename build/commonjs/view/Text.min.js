/**
 * Hilo 1.0.0 for commonjs
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
var Class=require("../core/Class"),Hilo=require("../core/Hilo"),View=require("./View"),CacheMixin=require("./CacheMixin"),Text=Class.create({Extends:View,Mixes:CacheMixin,constructor:function(t){t=t||{},this.id=this.id||t.id||Hilo.getUid("Text"),Text.superclass.constructor.call(this,t),t.font||(this.font="12px arial"),this._fontHeight=Text.measureFontHeight(this.font)},text:null,color:"#000",textAlign:null,textVAlign:null,outline:!1,lineSpacing:0,maxWidth:200,font:null,textWidth:0,textHeight:0,setFont:function(t){var e=this;return e.font!==t&&(e.font=t,e._fontHeight=Text.measureFontHeight(t)),e},render:function(t,e){var i=this;t.canvas;if("canvas"===t.renderType)i._draw(t.context);else if("dom"===t.renderType){var n=i.drawable,r=n.domElement,o=r.style;o.font=i.font,o.textAlign=i.textAlign,o.color=i.color,o.width=i.width+"px",o.height=i.height+"px",o.lineHeight=i._fontHeight+i.lineSpacing+"px",r.innerHTML=i.text,t.draw(this)}else i.cache(),t.draw(i)},_draw:function(t){var e=this,i=e.text.toString();if(i){t.font=e.font,t.textAlign=e.textAlign,t.textBaseline="top";var n,r,o,l,h,a=i.split(/\r\n|\r|\n|<br(?:[ \/])*>/),s=0,x=0,c=e._fontHeight+e.lineSpacing,d=[];for(n=0,l=a.length;l>n;n++)if(r=a[n],o=t.measureText(r).width,o<=e.maxWidth)d.push({text:r,y:x}),o>s&&(s=o),x+=c;else{var g,u,f,w="",m=0;for(u=0,h=r.length;h>u;u++)f=r[u],g=t.measureText(w+f).width,g>e.maxWidth?(d.push({text:w,y:x}),m>s&&(s=m),x+=c,w=f):(m=g,w+=f),u==h-1&&(d.push({text:w,y:x}),w!==f&&g>s&&(s=g),x+=c)}e.textWidth=s,e.textHeight=x,e.width||(e.width=s),e.height||(e.height=x);var p=0;switch(e.textVAlign){case"middle":p=e.height-e.textHeight>>1;break;case"bottom":p=e.height-e.textHeight}var H=e.background;H&&(t.fillStyle=H,t.fillRect(0,0,e.width,e.height)),e.outline?t.strokeStyle=e.color:t.fillStyle=e.color;for(var n=0;n<d.length;n++){var r=d[n];e._drawTextLine(t,r.text,p+r.y)}}},_drawTextLine:function(t,e,i){var n=this,r=0,o=n.width;switch(n.textAlign){case"center":r=o>>1;break;case"right":case"end":r=o}n.outline?t.strokeText(e,r,i):t.fillText(e,r,i)},Statics:{measureFontHeight:function(t){var e,i=document.documentElement,n=Hilo.createElement("div",{style:{font:t,position:"absolute"},innerHTML:"M"});return i.appendChild(n),e=n.offsetHeight,i.removeChild(n),e}}});module.exports=Text;