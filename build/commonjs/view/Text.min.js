/**
 * Hilo 1.0.2 for commonjs
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
var Class=require("..coreClass"),Hilo=require("..coreHilo"),View=require("./View"),CacheMixin=require("./CacheMixin"),Text=Class.create({Extends:View,Mixes:CacheMixin,constructor:function(t){t=t||{},this.id=this.id||t.id||Hilo.getUid("Text"),Text.superclass.constructor.call(this,t),t.font||(this.font="12px arial")},text:null,color:"#000",textAlign:null,textVAlign:null,outline:!1,lineSpacing:0,maxWidth:200,font:null,textWidth:0,textHeight:0,_props:null,_wordWidthCache:{},setFont:function(t){var e=this;return e.font!==t&&(e.font=t,e._props=null,e._wordWidthCache={},setTimeout(function(){e.cache()},0)),e},render:function(t,e){var i=this;if("canvas"===t.renderType)i._cacheDirty?i._draw(t.context):t.draw(i);else if("dom"===t.renderType){var n=i.drawable,r=n.domElement,h=r.style;h.font=i.font,h.textAlign=i.textAlign,h.color=i.color,h.width=i.width+"px",h.height=i.height+"px",h.lineHeight=i._fontHeight+i.lineSpacing+"px",t.draw(this),i._cacheDirty?(r.style.backgroundImage="",r.innerHTML=i.text):r.innerHTML=""}else t.draw(i)},cache:function(t){var e=this;if(t||e._cacheDirty||!e._cacheImage){if(Hilo.browser.supportCanvas){e._cacheCanvas=document.createElement("canvas"),e._cacheContext=e._cacheCanvas.getContext("2d"),e._setDrawingStyle(e._cacheContext);var i=e._getTextProps(e._cacheContext,e.text);e._cacheCanvas.width=i.width,e._cacheCanvas.height=i.height,e._props=i}e.updateCache()}e._cacheDirty=!t},_draw:function(t){var e=this,i=e.text.toString();if(i){e._setDrawingStyle(t),this._props||(this._props=this._getTextProps(t,i));var n=this._props.drawLines,r=this._props.width,h=this._props.height;e.textWidth=r,e.textHeight=h,e.width||(e.width=r),e.height||(e.height=h);var a=0;switch(e.textVAlign){case"middle":a=e.height-e.textHeight>>1;break;case"bottom":a=e.height-e.textHeight}var o=e.background;o&&(t.fillStyle=o,t.fillRect(0,0,e.width,e.height)),e.outline?t.strokeStyle=e.color:t.fillStyle=e.color;for(var s=0;s<n.length;s++){var c=n[s];e._drawTextLine(t,c.text,a+c.y)}}},_drawTextLine:function(t,e,i){var n=this,r=0,h=n.width;switch(n.textAlign){case"center":r=h>>1;break;case"right":case"end":r=h}n.outline?t.strokeText(e,r,i):t.fillText(e,r,i)},_setDrawingStyle:function(t){var e=this;t.font=e.font,t.textAlign=e.textAlign,t.textBaseline="top"},_getTextProps:function(t,e){var i=this;i._fontHeight=this._measureFontHeight();var n,r,h,a,o,s=e.split(/\r\n|\r|\n|<br(?:[ \/])*>/),c=0,l=0,d=i._fontHeight+i.lineSpacing,x=[];for(n=0,a=s.length;n<a;n++)if(r=s[n],h=i._measureTextWidth(t,e),h<=i.maxWidth)x.push({text:r,y:l}),c<h&&(c=h),l+=d;else{var g,u,f,_="",p=0;for(u=0,o=r.length;u<o;u++)f=r[u],g=i._measureTextWidth(t,_+f),g>i.maxWidth?(x.push({text:_,y:l}),c<p&&(c=p),l+=d,_=f):(p=g,_+=f),u==o-1&&(x.push({text:_,y:l}),_!==f&&c<g&&(c=g),l+=d)}return{drawLines:x,width:c,height:l}},_measureTextWidth:function(t,e){for(var i=0,n=0,r=e.length;n<r;n+=1){var h=e[n];i+=this._wordWidthCache[h]?this._wordWidthCache[h]:t.measureText(h).width}return i},_measureFontHeight:function(){var t=this;return Text.measureFontHeight(t.text)},Statics:{measureFontHeight:function(t){var e=document.documentElement,i=Hilo.createElement("div",{style:{font:this.font,position:"absolute"},innerHTML:"|MÃ‰q"});return e.appendChild(i),fontHeight=i.offsetHeight,e.removeChild(i),fontHeight}}});module.exports=Text;