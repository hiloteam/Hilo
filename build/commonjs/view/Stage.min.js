/**
 * Hilo 1.0.1 for commonjs
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
var Hilo=require("../core/Hilo"),Class=require("../core/Class"),Container=require("./Container"),CanvasRenderer=require("../renderer/CanvasRenderer"),DOMRenderer=require("../renderer/DOMRenderer"),WebGLRenderer=require("../renderer/WebGLRenderer"),Stage=Class.create({Extends:Container,constructor:function(e){e=e||{},this.id=this.id||e.id||Hilo.getUid("Stage"),Stage.superclass.constructor.call(this,e),this._initRenderer(e);var t=this.width,r=this.height,n=this.updateViewport();e.width||(t=n&&n.width||320),e.height||(r=n&&n.height||480),this.resize(t,r,!0)},canvas:null,renderer:null,paused:!1,viewport:null,_initRenderer:function(e){var t=e.canvas,r=e.container,n=e.renderType||"canvas";if("string"==typeof t&&(t=Hilo.getElement(t)),"string"==typeof r&&(r=Hilo.getElement(r)),t)t.getContext||(n="dom");else{var i="dom"===n?"div":"canvas";t=Hilo.createElement(i,{style:{position:"absolute"}})}this.canvas=t,r&&r.appendChild(t);var s={canvas:t,stage:this};switch(n){case"dom":this.renderer=new DOMRenderer(s);break;case"webgl":WebGLRenderer.isSupport()?this.renderer=new WebGLRenderer(s):this.renderer=new CanvasRenderer(s);break;case"canvas":default:this.renderer=new CanvasRenderer(s)}},addTo:function(e){var t=this.canvas;return t.parentNode!==e&&e.appendChild(t),this},tick:function(e){this.paused||this._render(this.renderer,e)},enableDOMEvent:function(e,t){for(var r=this,n=r.canvas,i="string"==typeof e?[e]:e,t=t!==!1,s=r._domListener||(r._domListener=function(e){r._onDOMEvent(e)}),a=0;a<i.length;a++){var e=i[a];t?n.addEventListener(e,s,!1):n.removeEventListener(e,s)}return r},_onDOMEvent:function(e){var t=e.type,r=e,n=0==t.indexOf("touch"),i=e;if(n){var s=e.touches,a=e.changedTouches;i=s&&s.length?s[0]:a&&a.length?a[0]:null}var o=i.pageX||i.clientX,d=i.pageY||i.clientY,h=this.viewport||this.updateViewport();r.stageX=o=(o-h.left)/this.scaleX,r.stageY=d=(d-h.top)/this.scaleY,r.stopPropagation=function(){this._stopPropagationed=!0};var u=this.getViewAtPoint(o,d,!0,!1,!0)||this,l=this.canvas,c=this._eventTarget,v="mouseout"===t;if(c&&(c!=u&&(!c.contains||!c.contains(u))||v)){var p="touchmove"===t?"touchout":"mousemove"===t||v||!u?"mouseout":null;if(p){var g=Hilo.copy({},r);g.type=p,g.eventTarget=c,c._fireMouseEvent(g)}r.lastEventTarget=c,this._eventTarget=null}if(u&&u.pointerEnabled&&"mouseout"!==t&&(r.eventTarget=this._eventTarget=u,u._fireMouseEvent(r)),!n){var f=u&&u.pointerEnabled&&u.useHandCursor?"pointer":"";l.style.cursor=f}Hilo.browser.android&&"touchmove"===t&&e.preventDefault()},updateViewport:function(){var e=this.canvas,t=null;return e.parentNode&&(t=this.viewport=Hilo.getElementRect(e)),t},resize:function(e,t,r){(r||this.width!==e||this.height!==t)&&(this.width=e,this.height=t,this.renderer.resize(e,t),this.updateViewport())}});module.exports=Stage;