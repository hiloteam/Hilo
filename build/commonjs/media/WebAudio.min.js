/**
 * Hilo 1.0.1 for commonjs
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
var Hilo=require("../core/Hilo"),Class=require("../core/Class"),EventMixin=require("../event/EventMixin"),WebAudio=function(){var e=window.AudioContext||window.webkitAudioContext,t=e?new e:null;return Class.create({Mixes:EventMixin,constructor:function(e){Hilo.copy(this,e,!0),this._init()},src:null,loop:!1,autoPlay:!1,loaded:!1,playing:!1,duration:0,volume:1,muted:!1,_context:null,_gainNode:null,_buffer:null,_audioNode:null,_startTime:0,_offset:0,_init:function(){this._context=t,this._gainNode=t.createGain?t.createGain():t.createGainNode(),this._gainNode.connect(t.destination),this._onAudioEvent=this._onAudioEvent.bind(this),this._onDecodeComplete=this._onDecodeComplete.bind(this),this._onDecodeError=this._onDecodeError.bind(this)},load:function(){if(!this._buffer){var e=WebAudio._bufferCache[this.src];if(e)this._onDecodeComplete(e);else{var t=new XMLHttpRequest;t.src=this.src,t.open("GET",this.src,!0),t.responseType="arraybuffer",t.onload=this._onAudioEvent,t.onprogress=this._onAudioEvent,t.onerror=this._onAudioEvent,t.send()}this._buffer=!0}return this},_onAudioEvent:function(e){var t=e.type;switch(t){case"load":var i=e.target;i.onload=i.onprogress=i.onerror=null,this._context.decodeAudioData(i.response,this._onDecodeComplete,this._onDecodeError),i=null;break;case"ended":this.playing=!1,this.fire("end"),this.loop&&this._doPlay();break;case"progress":this.fire(e);break;case"error":this.fire(e)}},_onDecodeComplete:function(e){WebAudio._bufferCache[this.src]||(WebAudio._bufferCache[this.src]=e),this._buffer=e,this.loaded=!0,this.duration=e.duration,this.fire("load"),this.autoPlay&&this._doPlay()},_onDecodeError:function(){this.fire("error")},_doPlay:function(){this._clearAudioNode();var e=this._context.createBufferSource();e.start||(e.start=e.noteOn,e.stop=e.noteOff),e.buffer=this._buffer,e.onended=this._onAudioEvent,this._gainNode.gain.value=this.muted?0:this.volume,e.connect(this._gainNode),e.start(0,this._offset),this._audioNode=e,this._startTime=this._context.currentTime,this.playing=!0},_clearAudioNode:function(){var e=this._audioNode;e&&(e.onended=null,e.disconnect(0),this._audioNode=null)},play:function(){return this.playing&&this.stop(),this.loaded?this._doPlay():this._buffer||(this.autoPlay=!0,this.load()),this},pause:function(){return this.playing&&(this._audioNode.stop(0),this._offset+=this._context.currentTime-this._startTime,this.playing=!1),this},resume:function(){return this.playing||this._doPlay(),this},stop:function(){return this.playing&&(this._audioNode.stop(0),this._audioNode.disconnect(),this._offset=0,this.playing=!1),this},setVolume:function(e){return this.volume!=e&&(this.volume=e,this._gainNode.gain.value=e),this},setMute:function(e){return this.muted!=e&&(this.muted=e,this._gainNode.gain.value=e?0:this.volume),this},Statics:{isSupported:null!=e,enabled:!1,enable:function(){if(!this.enabled&&t){var e=t.createBufferSource();return e.buffer=t.createBuffer(1,1,22050),e.connect(t.destination),e.start?e.start(0,0,0):e.noteOn(0,0,0),this.enabled=!0,!0}return this.enabled},_bufferCache:{},clearBufferCache:function(e){e?this._bufferCache[e]=null:this._bufferCache={}}}})}();module.exports=WebAudio;