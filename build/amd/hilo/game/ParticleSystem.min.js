/**
 * Hilo 1.0.0 for amd
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
define("hilo/game/ParticleSystem",["hilo/core/Hilo","hilo/core/Class","hilo/view/View","hilo/view/Container","hilo/view/Bitmap","hilo/view/Drawable"],function(t,i,s,e,h,a){var r=function(){function h(t,i){return i?t+2*(Math.random()-.5)*i:t}for(var r=["x","y","vx","vy","ax","ay","rotation","rotationV","scale","scaleV","alpha","alphaV","life"],n=[],o=0,m=r.length;m>o;o++){var l=r[o];n.push(l),n.push(l+"Var")}var c={x:0,y:0,vx:0,vy:0,ax:0,ay:0,scale:1,scaleV:0,alpha:1,alphaV:0,rotation:0,rotationV:0,life:1},u=[],d=i.create({Extends:e,constructor:function p(i){this.id=this.id||i.id||t.getUid("ParticleSystem"),this.emitterX=0,this.emitterY=0,this.gx=0,this.gy=0,this.totalTime=1/0,this.emitNum=10,this.emitNumVar=0,this.emitTime=.2,this.emitTimeVar=0,this.particle={},p.superclass.constructor.call(this,i),this.reset(i)},Statics:{PROPS:n,PROPS_DEFAULT:c,diedParticles:u},reset:function(i){t.copy(this,i),this.particle.system=this,this.totalTime<=0&&(this.totalTime=1/0)},onUpdate:function(t){t*=.001,this._isRun&&(this._totalRunTime+=t,this._currentRunTime+=t,this._currentRunTime>=this._emitTime&&(this._currentRunTime=0,this._emitTime=h(this.emitTime,this.emitTimeVar),this._emit()),this._totalRunTime>=this.totalTime&&this.stop())},_emit:function(){for(var t=h(this.emitNum,this.emitNumVar)>>0,i=0;t>i;i++)this.addChild(v.create(this.particle))},start:function(){this.stop(!0),this._currentRunTime=0,this._totalRunTime=0,this._isRun=!0,this._emitTime=h(this.emitTime,this.emitTimeVar)},stop:function(t){if(this.isRun=!1,t)for(var i=this.children.length-1;i>=0;i--)this.children[i].destroy()}}),v=i.create({Extends:s,constructor:function f(i){this.id=this.id||i.id||t.getUid("Particle"),f.superclass.constructor.call(this,i),this.init(i)},onUpdate:function(t){if(t*=.001,!this._died){var i=this.ax+this.system.gx,s=this.ay+this.system.gy;this.vx+=i*t,this.vy+=s*t,this.x+=this.vx*t,this.y+=this.vy*t,this.rotation+=this.rotationV,this._time>.1&&(this.alpha+=this.alphaV),this.scale+=this.scaleV,this.scaleX=this.scaleY=this.scale,this._time+=t,(this._time>=this.life||this.alpha<0)&&this.destroy()}},setImage:function(t,i){this.drawable=this.drawable||new a;var i=i||[0,0,t.width,t.height];this.width=i[2],this.height=i[3],this.drawable.rect=i,this.drawable.image=t},destroy:function(){this.died=!0,this.removeFromParent(),u.push(this)},init:function(t){this.system=t.system,this._died=!1,this._time=0,this.alpha=1;for(var i=0,s=n.length;s>i;i++){var e=n[i],a=void 0===t[e]?c[e]:t[e];this[e]=h(a,t[e+"Var"])}if(this.x+=this.system.emitterX,this.y+=this.system.emitterY,t.image){var r=t.frame;r&&r[0].length&&(r=r[Math.random()*r.length>>0]),this.setImage(t.image,r),void 0!==t.pivotX&&(this.pivotX=t.pivotX*r[2]),void 0!==t.pivotY&&(this.pivotY=t.pivotY*r[3])}},Statics:{create:function(t){if(u.length>0){var i=u.pop();return i.init(t),i}return new v(t)}}});return d}();return r});