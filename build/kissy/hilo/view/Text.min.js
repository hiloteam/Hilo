/**
 * Hilo 1.0.2 for kissy
 * Copyright 2016 alibaba.com
 * Licensed under the MIT License
 */
KISSY.add("hilo/view/Text",function(t,e,i,n,h){var r=e.create({Extends:n,Mixes:h,constructor:function(t){t=t||{},this.id=this.id||t.id||i.getUid("Text"),r.superclass.constructor.call(this,t),t.font||(this.font="12px arial")},text:null,color:"#000",textAlign:null,textVAlign:null,outline:!1,lineSpacing:0,maxWidth:200,font:null,textWidth:0,textHeight:0,_props:null,_wordWidthCache:{},setFont:function(t){var e=this;return e.font!==t&&(e.font=t,e._props=null,e._wordWidthCache={},setTimeout(function(){e.cache()},0)),e},render:function(t,e){var i=this;if("canvas"===t.renderType)i._cacheDirty?i._draw(t.context):t.draw(i);else if("dom"===t.renderType){var n=i.drawable,h=n.domElement,r=h.style;r.font=i.font,r.textAlign=i.textAlign,r.color=i.color,r.width=i.width+"px",r.height=i.height+"px",r.lineHeight=i._fontHeight+i.lineSpacing+"px",t.draw(this),i._cacheDirty?(h.style.backgroundImage="",h.innerHTML=i.text):h.innerHTML=""}else t.draw(i)},cache:function(t){var e=this;if(t||e._cacheDirty||!e._cacheImage){if(i.browser.supportCanvas){e._cacheCanvas=document.createElement("canvas"),e._cacheContext=e._cacheCanvas.getContext("2d"),e._setDrawingStyle(e._cacheContext);var n=e._getTextProps(e._cacheContext,e.text);e._cacheCanvas.width=n.width,e._cacheCanvas.height=n.height,e._props=n}e.updateCache()}e._cacheDirty=!t},_draw:function(t){var e=this,i=e.text.toString();if(i){e._setDrawingStyle(t),this._props||(this._props=this._getTextProps(t,i));var n=this._props.drawLines,h=this._props.width,r=this._props.height;e.textWidth=h,e.textHeight=r,e.width||(e.width=h),e.height||(e.height=r);var a=0;switch(e.textVAlign){case"middle":a=e.height-e.textHeight>>1;break;case"bottom":a=e.height-e.textHeight}var o=e.background;o&&(t.fillStyle=o,t.fillRect(0,0,e.width,e.height)),e.outline?t.strokeStyle=e.color:t.fillStyle=e.color;for(var s=0;s<n.length;s++){var c=n[s];e._drawTextLine(t,c.text,a+c.y)}}},_drawTextLine:function(t,e,i){var n=this,h=0,r=n.width;switch(n.textAlign){case"center":h=r>>1;break;case"right":case"end":h=r}n.outline?t.strokeText(e,h,i):t.fillText(e,h,i)},_setDrawingStyle:function(t){var e=this;t.font=e.font,t.textAlign=e.textAlign,t.textBaseline="top"},_getTextProps:function(t,e){var i=this;i._fontHeight=this._measureFontHeight();var n,h,r,a,o,s=e.split(/\r\n|\r|\n|<br(?:[ \/])*>/),c=0,l=0,d=i._fontHeight+i.lineSpacing,g=[];for(n=0,a=s.length;n<a;n++)if(h=s[n],r=i._measureTextWidth(t,e),r<=i.maxWidth)g.push({text:h,y:l}),c<r&&(c=r),l+=d;else{var u,x,f,_="",p=0;for(x=0,o=h.length;x<o;x++)f=h[x],u=i._measureTextWidth(t,_+f),u>i.maxWidth?(g.push({text:_,y:l}),c<p&&(c=p),l+=d,_=f):(p=u,_+=f),x==o-1&&(g.push({text:_,y:l}),_!==f&&c<u&&(c=u),l+=d)}return{drawLines:g,width:c,height:l}},_measureTextWidth:function(t,e){for(var i=0,n=0,h=e.length;n<h;n+=1){var r=e[n];i+=this._wordWidthCache[r]?this._wordWidthCache[r]:t.measureText(r).width}return i},_measureFontHeight:function(){var t=this;return r.measureFontHeight(t.text)},Statics:{measureFontHeight:function(t){var e=document.documentElement,n=i.createElement("div",{style:{font:this.font,position:"absolute"},innerHTML:"|MÃ‰q"});return e.appendChild(n),fontHeight=n.offsetHeight,e.removeChild(n),fontHeight}}});return r},{requires:["hilo/core/Class","hilo/core/Hilo","hilo/view/View","hilo/view/CacheMixin"]});